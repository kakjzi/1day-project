# Admin Frontend Business Logic Model

## 1. 인증 로직

### 1.1 로그인 플로우

```
1. 사용자 입력: store_id, username, password
2. API 호출: POST /api/admin/login
3. 성공 시:
   - JWT 토큰 localStorage 저장
   - Admin 정보 Context에 저장
   - 대시보드로 리다이렉트
4. 실패 시:
   - 에러 메시지 표시
   - 입력 필드 유지
```

### 1.2 관리자 등록 플로우

```
1. 사용자 입력: store_id, username, password, password_confirm
2. 클라이언트 검증:
   - 비밀번호 일치 확인
   - 필수 필드 확인
3. API 호출: POST /api/admin/register
4. 성공 시:
   - 성공 메시지 표시
   - 로그인 페이지로 리다이렉트
5. 실패 시:
   - 에러 메시지 표시 (중복 사용자명 등)
```

### 1.3 세션 관리

```
1. 앱 시작 시:
   - localStorage에서 토큰 확인
   - 토큰 있으면 유효성 검증 (API 호출 또는 JWT 디코딩)
   - 유효하면 인증 상태 유지
   - 만료되었으면 로그인 페이지로 리다이렉트

2. API 호출 시:
   - Authorization 헤더에 토큰 포함
   - 401 응답 시 로그아웃 처리

3. 로그아웃:
   - localStorage 토큰 삭제
   - Context 초기화
   - 로그인 페이지로 리다이렉트
```

---

## 2. 주문 모니터링 로직

### 2.1 SSE 연결 관리

```
1. 대시보드 마운트 시:
   - SSE 연결 시작: GET /api/admin/orders/stream?store_id={id}&token={jwt}
   - 쿼리 파라미터로 인증 (EventSource API는 커스텀 헤더 미지원)
   - 연결 상태 표시

2. 이벤트 수신 시:
   - NEW_ORDER: 테이블 카드에 주문 추가, 알림음 재생
   - ORDER_UPDATE: 해당 주문 상태 업데이트
   - ORDER_DELETE: 해당 주문 제거
   - TABLE_UPDATE: 테이블 정보 업데이트

3. 연결 끊김 시:
   - 자동 재연결 시도 (3초 간격, 최대 5회)
   - 재연결 실패 시 에러 표시 + 수동 재연결 버튼

4. 대시보드 언마운트 시:
   - SSE 연결 종료
```

### 2.2 신규 주문 알림

```
1. NEW_ORDER 이벤트 수신
2. 브라우저 알림음 재생 (Audio API)
3. 해당 테이블 카드 시각적 강조:
   - 배경색 변경 (하이라이트)
   - 3초 후 원래 색상으로 복귀
4. 테이블 카드 주문 목록 업데이트
```

### 2.3 테이블 카드 데이터 구조

```
테이블 카드 표시 정보:
- 테이블 번호
- 현재 총 주문액
- 최근 주문 5개 (미리보기)
  - 주문 번호
  - 주문 시각
  - 주문 상태 (색상 표시)
  - 메뉴 요약 (첫 번째 메뉴 + 외 N개)
- 클릭 시 전체 주문 목록 모달
```

---

## 3. 주문 관리 로직

### 3.1 주문 상태 변경

```
1. 상태 변경 버튼 클릭 (확인 팝업 없이 즉시)
2. API 호출: PATCH /api/admin/orders/{id}/status
3. 성공 시:
   - 로컬 상태 업데이트 (Optimistic Update)
   - SSE로 다른 클라이언트에 전파됨
4. 실패 시:
   - 에러 토스트 표시
   - 로컬 상태 롤백
```

### 3.2 주문 상태 전이

```
PENDING(대기중) → ACCEPTED(접수) → PREPARING(준비중) → COMPLETED(완료)

- 각 상태에서 다음 상태로만 전이 가능
- 이전 상태로 되돌리기 불가
- COMPLETED 상태는 최종 상태
```

### 3.3 주문 삭제

```
1. 삭제 버튼 클릭
2. 확인 팝업 표시: "주문 #123을 삭제하시겠습니까?"
3. 확인 시:
   - API 호출: DELETE /api/admin/orders/{id}
   - 성공: 로컬 상태에서 제거, 테이블 총액 재계산
   - 실패: 에러 메시지 표시
4. 취소 시: 팝업 닫기

제약사항:
- COMPLETED 상태 주문은 삭제 불가 (버튼 비활성화)
```

---

## 4. 테이블 관리 로직

### 4.1 테이블 이용 완료

```
1. "이용 완료" 버튼 클릭
2. 확인 팝업: "테이블 #5 이용을 완료하시겠습니까? 현재 주문이 이력으로 이동됩니다."
3. 확인 시:
   - API 호출: POST /api/admin/tables/{id}/complete
   - 성공:
     - 테이블 카드 리셋 (주문 목록 비움, 총액 0원)
     - 성공 토스트 표시
   - 실패: 에러 메시지 표시
```

### 4.2 테이블 간 주문 이동

```
1. "이동" 버튼 클릭
2. 대상 테이블 선택 모달 표시
   - 현재 테이블 제외한 테이블 목록
   - 각 테이블의 현재 상태 표시
3. 대상 테이블 선택
4. 확인 팝업: "테이블 #5의 주문을 테이블 #7로 이동하시겠습니까?"
5. 확인 시:
   - API 호출: POST /api/admin/tables/{id}/transfer
   - 성공:
     - 원본 테이블 리셋
     - 대상 테이블 주문 목록 + 총액 업데이트
   - 실패: 에러 메시지 표시
```

### 4.3 과거 주문 조회

```
1. "과거 내역" 버튼 클릭
2. 과거 주문 모달 표시
   - 기본: 오늘 날짜 선택됨
   - 날짜 선택 필터 (DatePicker)
3. 날짜 선택 시:
   - API 호출: GET /api/admin/tables/{id}/history?date=YYYY-MM-DD
   - 결과 목록 표시 (시간 역순)
4. 각 주문 정보:
   - 주문 번호
   - 주문 시각
   - 메뉴 목록
   - 총 금액
   - 이용 완료 시각
5. "닫기" 버튼으로 모달 닫기
```

---

## 5. 메뉴 관리 로직

### 5.1 메뉴 목록 조회

```
1. 메뉴 관리 페이지 진입
2. 카테고리 목록 로드: GET /api/categories
3. 첫 번째 카테고리 자동 선택
4. 해당 카테고리 메뉴 로드: GET /api/menus?category_id={id}
5. 카테고리 탭 클릭 시 해당 카테고리 메뉴 로드
```

### 5.2 메뉴 등록

```
1. "메뉴 추가" 버튼 클릭
2. 메뉴 등록 폼 표시
3. 입력 필드:
   - 메뉴명 (필수)
   - 가격 (필수)
   - 설명 (선택)
   - 카테고리 (필수, 드롭다운)
   - 이미지 (선택, 파일 업로드)
4. 이미지 선택 시:
   - 파일 선택
   - 미리보기 표시
   - 업로드: POST /api/admin/upload
   - 업로드된 URL 저장
5. "저장" 클릭:
   - 입력 검증
   - API 호출: POST /api/admin/menus
   - 성공: 목록 새로고침, 폼 닫기
   - 실패: 에러 메시지 표시
```

### 5.3 메뉴 수정

```
1. 메뉴 카드 "수정" 버튼 클릭
2. 메뉴 수정 폼 표시 (기존 데이터 로드)
3. 수정 후 "저장" 클릭:
   - API 호출: PUT /api/admin/menus/{id}
   - 성공: 목록 새로고침, 폼 닫기
```

### 5.4 메뉴 삭제

```
1. 메뉴 카드 "삭제" 버튼 클릭
2. 확인 팝업: "메뉴 '김치찌개'를 삭제하시겠습니까?"
3. 확인 시:
   - API 호출: DELETE /api/admin/menus/{id}
   - 성공: 목록에서 제거
```

### 5.5 옵션 그룹 관리

```
1. 메뉴 상세에서 "옵션 관리" 버튼 클릭
2. 옵션 그룹 목록 표시
3. 옵션 그룹 추가:
   - 그룹명, 필수 여부, 최대 선택 수
   - 옵션 항목 추가 (이름, 추가 가격)
4. API 호출: POST /api/admin/menus/{id}/options
```

### 5.6 카테고리 관리

```
1. "카테고리 관리" 버튼 클릭
2. 카테고리 목록 모달 표시
3. 추가/수정/삭제 기능
4. 순서 변경 (드래그 앤 드롭 또는 화살표 버튼)
```

---

## 6. 이미지 업로드 로직

### 6.1 업로드 플로우

```
1. 파일 선택 (input type="file")
2. 파일 검증:
   - 타입: image/jpeg, image/png, image/gif, image/webp
   - 크기: 최대 1MB
3. 미리보기 생성 (FileReader API)
4. 미리보기 표시
5. 폼 제출 시:
   - FormData로 파일 전송
   - API 호출: POST /api/admin/upload
   - 응답에서 URL 추출
   - 메뉴 데이터에 URL 포함
```

### 6.2 에러 처리

```
- FILE_001: 파일 크기 초과 → "이미지 크기는 1MB 이하여야 합니다"
- FILE_002: 지원하지 않는 형식 → "JPG, PNG, GIF, WebP 형식만 지원합니다"
```
